DEFAULT_RSPM_REPO_ID <-  "1" # cran
DEFAULT_RSPM <-  "https://packagemanager.rstudio.com"



vetiver_write_docker <- function(vetiver_model,
                                 plumber_file = "plumber.R",
                                 path = ".",
                                 ...) {

    pkgs <- unique(c(infra_pkgs, v$metadata$required_pkgs))
    lockfile <- write_renv_lockfile(path = path, pkgs = pkgs)
    sys_reqs <- glue_sys_reqs(pkgs)
    copy_renv <- glue("COPY {lockfile} /opt/ml/renv.lock")
    copy_plumber <- glue("COPY {plumber_file} /opt/ml/plumber.R")


    ret <- compact(list(
        "# Generated by the vetiver package; edit with care\n",
        ## https://github.com/rstudio/plumber/blob/main/Dockerfile:
        "FROM rstudio/plumber:latest\n",
        sys_reqs,
        '\nARG RENV_REF=main',
        'RUN Rscript -e "remotes::install_github(\'rstudio/renv@${RENV_REF}\')"\n',
        copy_renv,
        copy_plumber,
        '\nRUN R -e "renv::restore()"\n',
        'CMD ["/opt/ml/plumber.R"]'
    ))

    readr::write_lines(ret, file = file.path(path, "Dockerfile"))
}


write_renv_lockfile <- function(path, pkgs) {
    lockfile <- renv::paths$lockfile(project = path)
    renv::snapshot(
        project = path,
        lockfile = lockfile,
        packages = pkgs,
        prompt = FALSE,
        force = TRUE
    )
    lockfile
}

glue_sys_reqs <- function(pkgs) {
    rspm <- Sys.getenv("RSPM_ROOT", DEFAULT_RSPM)
    rspm_repo_id <- Sys.getenv("RSPM_REPO_ID", DEFAULT_RSPM_REPO_ID)
    rspm_repo_url <- glue("{rspm}/__api__/repos/{rspm_repo_id}")

    pkgnames <- glue_collapse(pkgs, sep = "&pkgname=")

    req_url <- glue(
        "{rspm_repo_url}/sysreqs?all=false",
        "&pkgname={pkgnames}&distribution=ubuntu&release=20.04"
    )
    res <- curl::curl_fetch_memory(req_url)
    sys_reqs <- jsonlite::fromJSON(rawToChar(res$content), simplifyVector = FALSE)
    if (!is.null(sys_reqs$error)) {
        rlang::abort(sys_reqs$error)
    }
    sys_reqs <- map(sys_reqs$requirements, pluck, "requirements", "packages")
    sys_reqs <- unique(map_chr(sys_reqs, 1L))
    sys_reqs <- glue_collapse(sys_reqs, sep = " \\\n  ")
    glue(
        "RUN apt-get update -qq && ",
        "apt-get install -y --no-install-recommends \\\n  ",
        sys_reqs,
        .trim = FALSE
    )
}

