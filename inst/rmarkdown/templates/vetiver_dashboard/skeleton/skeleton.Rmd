---
title: "Monitor model"
output: 
  vetiver::vetiver_dashboard:
    board: !expr pins::board_rsconnect()
    name: 'julia.silge/hotel_rf'
    storyboard: true
    source_code: 'https://vetiver.rstudio.com'
    display_pins: true
params:
    board: !r pins::board_rsconnect()
    name: 'julia.silge/hotel_rf'
    version: NULL
---

```{r setup, include = FALSE}
library(vetiver)
library(tidyverse)
library(tidymodels)
library(pins)
library(plotly)
library(lubridate)
knitr::opts_chunk$set(echo = FALSE)

## load new validation data, for example from database or API
validation_data_url <- 'https://tidymodels.org/start/case-study/hotels.csv'
validation_df <- read_csv(validation_data_url) %>%
    mutate_if(is.character, as.factor) %>%
    filter(arrival_date > "2017-01-01") 

v <- vetiver_pin_read(params$board, params$name, version = params$version)

## do metrics at training time
v_meta <- pin_meta(params$board, params$name)
validation_aug <- augment(v, validation_df)

metrics_pin_name <- paste(params$name, "metrics", sep = "_")







vetiver_aggregate_metrics <- function(df, time_var, time_aggregation, 
                                      truth, estimate, ..., metric_set = yardstick::metrics) {
    metrics_agg <-
        df %>%
        mutate_if(is.character, as.factor) %>%
        mutate("{{time_var}}" := floor_date(as.Date({{ time_var }}), unit = time_aggregation)) %>%
        group_by({{ time_var }}) %>%
        metric_set({{truth}}, {{estimate}}, ...)
    
    totals <- 
        df %>% 
        mutate("{{time_var}}" := floor_date(as.Date({{ time_var }}), unit = time_aggregation)) %>%
        count({{ time_var }}, name = "n_validation")
    
    metrics_agg %>% left_join(totals)
}

vetiver_pin_metrics <- function(df_metrics,  time_var, board, 
                                metrics_pin_name = paste(params$name, "metrics", sep = "_"), 
                                
                                initiate = FALSE) {
    
    
    old_metrics <- tibble()
    
    if (!initiate) {
        old_metrics <- pin_read(board, metrics_pin_name)
    }
    
    new_dates <- unique(pull(df_metrics, {{ time_var }}))
    
    new_metrics <- old_metrics %>%
        filter(!{{ time_var }} %in% new_dates) %>%
        bind_rows(df_metrics) %>%
        arrange(.metric, {{ time_var }})
    
    pin_write(board, new_metrics, basename(metrics_pin_name))
    
    new_metrics
    
}


new_metrics <-
    validation_aug %>%
    vetiver_aggregate_metrics(arrival_date, "week",
                              children, .pred_class, .pred_children) %>%
    vetiver_pin_metrics(arrival_date, params$board, metrics_pin_name)


```



### Model metrics

```{r}

plot_vetiver_metrics <- function(df, time_var) {
    ggplot(df, aes({{ time_var }}, .estimate)) +
        geom_line(aes(color = .metric)) +
        geom_point(aes(color = .metric, size = n_validation), alpha = 0.8) +
        facet_wrap(vars(.metric), scales = "free_y", ncol = 1) +
        labs(x = NULL, y = NULL)
}

p <- new_metrics %>%
    filter(.metric %in% c("accuracy", "roc_auc")) %>%
    plot_vetiver_metrics(arrival_date) +
    scale_size(range = c(0, 5))

p <- ggplotly(p)
hide_legend(p)
```


***

Plot model metrics over time to *monitor* your model.

### Explore validation data

```{r}
p_validate <-
    validation_df %>%
    ggplot(aes(average_daily_rate, after_stat(density), fill = children)) +
    geom_histogram(alpha = 0.7, position = "identity") +
    labs(fill = NULL)

ggplotly(p_validate)
```


***

Write your own code to make visualizations or tables with the new validation data, and/or the new predictions.

### API visual documentation

```{r echo=FALSE, out.width="100%"}
knitr::include_url("https://colorado.rstudio.com/rsc/children-at-hotels/", height = "600px")
```

***

Interact directly with your model via its visual documentation, and get `curl` examples.

